<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Bluestore SMR Support by shehbazj</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Bluestore SMR Support</h1>
      <h2 class="project-tagline">Google Summer of Code 2016</h2>
      <a href="https://github.com/shehbazj/ceph" class="btn">View on GitHub</a>
      <a href="https://github.com/shehbazj/ceph/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/shehbazj/ceph/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h2>
<a id="objective" class="anchor" href="#objective" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Objective.</h2>

<p>The Project targets supporting SMR drives for Ceph's Bluestore File System. SMR Drives support restricted access (sequential writes) across a zone. The objective of the project was to make the Bluestore File System capable of writing to SMR Drives.</p>

<h2>
<a id="smr-drives" class="anchor" href="#smr-drives" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>SMR Drives</h2>

<p>SMR Drives are of three types: Drive Managed, Host Aware and Host Managed. Drive Managed drives do not expose the internal zone configuration to the host file system. On the other hand, Host Aware and Host Managed drives expose their internal zone layout to the Host layer. A Host Managed SMR drive would not handle out of order writes within a zone. A Host Aware drive will manage out of order writes. This work was done on Host Aware SMR Drive, so even if we ended up doing out of order writes within a zone, the writes would get internally synchronized.</p>

<h2>
<a id="implementation" class="anchor" href="#implementation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Implementation.</h2>

<p>Writes two Bluestore filesystem have the following sequence of operations:
1. Allocating a region to write data to in-memory in the Allocator.
2. Performing write to device
3. Updating transaction Key in KV-DB.</p>

<p>Multiple threads can perform Step 1 parallelly by using the <a href="https://github.com/ceph/ceph/pull/9031">Bitmap Allocator</a>. Step 3 can also be done parallelly by using advanced KV interfaces. For Step 2, for all devices, we do not have multiple threads writing sequentially to the device. However, for SMR drives, we want to execute Step 2 sequentially.</p>

<h3>
<a id="benchmarking-smr-drives" class="anchor" href="#benchmarking-smr-drives" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Benchmarking SMR Drives</h3>

<p>HGST Created a <a href="https://github.com/hgst/libzbc">libzbc library</a> to benchmark Host Managed and Host Aware SMR drives. I implemented few benchmarking scripts that can be used to benchmark SMR drives <a href="https://github.com/ceph/ceph/pull/9534">PULL 9534</a></p>

<h3>
<a id="integrating-libzbc-library" class="anchor" href="#integrating-libzbc-library" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>integrating libzbc library</h3>

<p>libzbc library uses AutoMake by default. Since ceph has now migrated to CMakeLists, I added CMake to libzbc here <a href="https://github.com/ceph/libzbc/pull/2">PULL 2</a></p>

<h3>
<a id="device-query-code-to-allocator" class="anchor" href="#device-query-code-to-allocator" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>device query code to Allocator</h3>

<h3>
<a id="changes-in-freelist-manager" class="anchor" href="#changes-in-freelist-manager" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>changes in Freelist Manager</h3>

<h2>
<a id="todo" class="anchor" href="#todo" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>TODO</h2>

<h3>
<a id="add-support-for-ordered-thread-writes" class="anchor" href="#add-support-for-ordered-thread-writes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Add support for ordered thread writes</h3>

<h3>
<a id="add-cleaner--garbage-collector" class="anchor" href="#add-cleaner--garbage-collector" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Add cleaner / garbage collector</h3>

<h2>
<a id="howto" class="anchor" href="#howto" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>HOWTO</h2>

<h3>
<a id="enable-libzbc-compile-support" class="anchor" href="#enable-libzbc-compile-support" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Enable libzbc compile support</h3>

<p>set WITH_LIBZBC=1</p>

<h3>
<a id="enable-smr-allocator" class="anchor" href="#enable-smr-allocator" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Enable SMR Allocator</h3>

<p>set bluestore_block_allocator smr</p>

<h2>
<a id="contributors" class="anchor" href="#contributors" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Contributors</h2>

<p>This project is currently maintained by <a href="https://github.com/shehbazj" class="user-mention">@shehbazj</a>. A big thank you to mentor <a href="https://github.com/liewegas" class="user-mention">@liewegas</a> and collaborators <a href="https://github.com/allensamuels" class="user-mention">@allensamuels</a> <a href="https://github.com/chhabaramesh" class="user-mention">@chhabaramesh</a> <a href="https://github.com/alimaredia" class="user-mention">@alimaredia</a> <a href="https://github.com/badone" class="user-mention">@badone</a> who helped at different stages of the project.</p>

<h1>
<a id="contact" class="anchor" href="#contact" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Contact</h1>

<p>Signed-off-by: <a href="mailto:shehbaz.jaffer@mail.utoronto.ca">shehbaz.jaffer@mail.utoronto.ca</a></p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/shehbazj/ceph">Bluestore SMR Support</a> is maintained by <a href="https://github.com/shehbazj">shehbazj</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
